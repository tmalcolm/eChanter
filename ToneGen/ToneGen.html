<html>
<head><title>ToneGen - Audio sample generation for 8bit uCs</title>


<style>

.tabStrip ul {
	margin: 0;
	padding: 0;
	list-style-type: none;
}
.tabStrip li {
	margin: 0 2px 0 0;
	list-style-type: none;
	float: left;
}
.tabLink {
	display: block;
	text-decoration: none;
	padding: 5px;
	background: #e8e8e8;
	border: #dadada solid;
	border-width: 1px 1px 0 1px;
	color: #8a8a8a;
}
.tabLinkActive {
	display: block;
	text-decoration: none;
	padding: 5px;
	background: #e0e0e0;
	border: #c0c0c0 solid;
	border-width: 1px 1px 0 1px;
	color: #0066ff;
}
.tabContent {
	display: none;
}
.tabContentActive {
	display: block;
	clear: both;
	background: #f0f0f0;
	border: 1px #dedede solid;
	padding: 10px;
}
</style>

<script>

var DEBUG = false;

var outputTxtArea;
var dataTxt = "";
var dataObj = {};
var sampleRate;




// converts dB to Amplitude for an array of partials
// with corresponding levels
// expects data as an array of 2 element arrays
//   [[P, L], ... [Pn, Ln]]
// conversion will also normailze dB levels and
// apply a dB level boost before conversion

function convertDecibelsToAmplitude(partials, normalize, normVal) {

  // Multiple iterations over the partial data is not very efficient
  // but the iterations make for readable, are obvious code
  // and data sets are small so there's no real performance issue.

  var i = 0;
  var db = 0;
  var isDB = false;

  var min = max = partials[0][1];

  for (i = 0; i < partials.length; i++) {
    if (partials[i][1] < 0) {
      isDB = true;
      break;
    }

  }

  // do actual conversion from dB to Amplitude
  if (isDB) {
    for (i = 0; i < partials.length; i++) {
      if (partials[i][1] < min) min = partials[i][1];
      else if (partials[i][1] > max) max = partials[i][1];
    }


    for (i = 0; i < partials.length; i++) {
      db = partials[i][1];
      if (normalize) {
        db -= max * (normVal/100);
      }

      // do actual conversion from dB to Amplitude
      // forula is 10^(db/20)
      partials[i][1] = Math.pow(10, (db/20));

    }

  }


}


function getPartialsById(objId) {

  var p = [ [1.0, 1.0] ];
  for (var n=0; n < dataObj.length; n++) {

    if (dataObj[n]["id"] == objId) {
      // only assign it if it is really there
      if (dataObj[n]["partials"]) {
        p = dataObj[n]["partials"];
      }
      break;
    }
  }
  return p;

}


function scaleSample(dataObj) {

  var min = dataObj["min"];
  var max = dataObj["max"];
  var delta = 0;
  var mult = 1;
  var a = dataObj["amplitude"];
  var s = dataObj["samples"];

  if (min < 0 ) {
    delta = min * -1;
  }

  min = dataObj["min"] = min + delta;
  max = dataObj["max"] = max + delta;

  mult = 255 / max;

  alert ("min:"+ min + " max:" + max + " mult:"+ mult);

  for (var i = 0; i< s.length; i++) {
    // make positive, scale from 0-255, reduce by amplitude adjustment
    s[i] = ((s[i] + delta) * mult) * a;
    s[i] = s[i].toFixed(0);

    // assign rounded min/max vals
    if (s[i] > max) max = dataObj["max"] = max;
    else if (s[i] < min) min = dataObj["min"] = min;

  }



}


function outputSample(dataObj) {

  outputTxtArea.value +=    "f"+ dataObj["id"] +"_sr"+sampleRate+"_len = "+ dataObj["samples"].length +";"
	                        + "\n"
	                        + "f"+ dataObj["id"] +"_sr"+sampleRate+" ["+ dataObj["samples"].length +"] = { \n"
	                        + dataObj["samples"]
	                        + "\n"
	                        + "};"
	                        + "\n\n";

}

function generate() {


  dataTxt = document.getElementById("editor").value;
  dataObj = JSON.parse(dataTxt);
  outputTxtArea = document.getElementById("results");
  outputTxtArea.value = "";

  sampleRate = document.getElementById("sampleRate").value;
  sampleRate = parseInt(sampleRate);


  parseInputData();


  for (var n=0; n < dataObj.length; n++) {

    scaleSample(dataObj[n]);

    outputSample(dataObj[n]);

  }


  openTab(2);



}


function parseInputData() {

  var increment = 0.0;
  var nSamples = 0;
  var n, i, j, p, a = 0;
  var s = [];
  var id = "";
  var freq = 0.0;
  var amplitude = 0.0;
  var partials;


  if (DEBUG) alert (JSON.stringify(dataObj));
  if (DEBUG) alert ("sample rate: " + sampleRate +"\namp scaling: " + ampScalingFactor +"\ndc offset: " +dcOffset);


  // Sinewave generation derived from pseudocode at
  //     http://www.topherlee.com/software/pcm-tut-sine.html
  //
  for (n=0; n < dataObj.length; n++) {

    dataObj[n]["min"] = dataObj[n]["max"] = 0;
    s = [];

    id = dataObj[n]["id"];
    freq = dataObj[n]["frequency"]; // frequency of note
    if (dataObj[n]["amplitude"])
      amplitude = dataObj[n]["amplitude"]; // amplitude adjust for note (higher notes typically quieter)
    else
      amplitude = dataObj[n]["amplitude"] = 1.0;
    if (dataObj[n]["partials"])
      partials = dataObj[n]["partials"]; // list of partials and amplitudes for note
    else
      partials = dataObj[n]["partials"] = [ [1.0, 1.0] ];


    nSamples = parseInt(sampleRate/freq);
	increment = 2 * Math.PI * (freq/sampleRate);

    if (typeof partials == "string") {
      if (DEBUG) alert ("Copying partials for \'" + dataObj[n]["id"] + "\' from \'" + partials +"\'");
      partials = getPartialsById(partials);
    }

    for(i = 0; i < nSamples; i++) {

      // accumulate sample values with calculated partials
      // make positive 2.0 >= s <= 0.0
      // multiply by amplitude factor (default = 127)

      s[i] = 0.0;

      for (j = 0; j < partials.length; j++) {

        p = partials[j][0];
        a = partials[j][1];

        s[i] += Math.sin(p*increment*i) * a;


      }

      if (s[i] > dataObj[n]["max"]) dataObj[n]["max"] = s[i];
      else if (s[i] < dataObj[n]["min"]) dataObj[n]["min"] = s[i];

	}

    if (DEBUG) alert (s);

    dataObj[n]["samples"] = s;


  } // end for (var in object)


}


</script>

<script type="text/javascript" language="javascript">
  //http://kyleschaeffer.com/tutorials/create-a-dhtml-tab-strip/
var activeTab = 1;
function openTab(tabId) {
  // reset old tab and content
  document.getElementById("tabLink"+activeTab).className = "tabLink";
  document.getElementById("tabContent"+activeTab).className = "tabContent";
  // set new tab and content
  document.getElementById("tabLink"+tabId).className = "tabLinkActive";
  document.getElementById("tabContent"+tabId).className = "tabContentActive";
  activeTab = tabId;
}
</script>

<body onLoad="openTab(1);">

<h2>ToneGen</h2>
<h3>Audio sample generation, with partials, for 8bit Microcontrollers</h3>

<div id="sampleConfigPane">

Change all the inputs to be sample rate, amp scaling 1-127, remove clipping.<br>
Take dB stuff off this page and make conversion tool for converting SHARC data to Amplitude.<br>
Change Sine generation loop to 1) gen sample, 2) center between 0-2,
center between 0-255 by applying amplitude scaling 1-127.<br>
Enable Frequency relative to ID's freq, sample gen by ratio.<br>
<br>
<b>For DDS, Freq of 31.25Hz @ 8kHz sample rate generates 256 samples.</b>
<br>

  <p>Output as:</p>
  Sample Rate: <input id="sampleRate" type="text" value="8000">
  <br>
  Apply Amplitude Scaling factor of <input id="ampScalingFactor" type="text" value="50">
  and DC Offset <input id="dcOffset" type="text" value="100">
  <br>
  <input id="normalize" type="checkbox"> Normalize dB levels by <input id="normVal" type="text" value="100"> %
  </p>
  <input type="button" value="Generate now!" onClick="generate(); return false;" >
</div>

<div class="tabStrip">
	<ul>
		<li><a href="javascript:openTab(1);" class="tabLinkActive" id="tabLink1">Data</a></li>
		<li><a href="javascript:openTab(2);" class="tabLink" id="tabLink2">Output</a></li>
		<li><a href="javascript:openTab(3);" class="tabLink" id="tabLink3">Converters</a></li>
		<li><a href="javascript:openTab(4);" class="tabLink" id="tabLink4">Help</a></li>
	</ul>
</div>

<div  class="tabContent" id="tabContent1">
    <p>Spectrum data <br>
    Copy/paste from text editor
    </p>
    <textarea id="editor" style="width:400px; height:400px; overflow:auto; border:solid 1px #cccccc;">
[
  { "id"        : "clarinet_fundemental",
    "frequency" : 235.0,
    "amplitude" : 1.0,
    "partials"  : [
                     [1.0, 1.0],
                     [3.0, 0.75],
                     [5.0, 0.5],
                     [7.0, 0.14],
                     [9.0, 0.5],
                     [11.0, 0.12],
                     [13.0, 0.17]
                  ]
  },

  { "id"        : "clarinet_note_2",
    "frequency" : 470.0,
    "amplitude" : 0.92,
    "partials"  : "clarinet_fundemental"
  }
]
     </textarea>
  </div>


  <div  class="tabContent" id="tabContent2">
    <p>Sample array data  <br>
    Copy/paste into source code
    </p>
    <textarea id="results" style="width:450px; height:400px; overflow:auto; border:solid 1px #cccccc;">
    </textarea>
  </div>


  <div  class="tabContent" id="tabContent3">
    <h2>Convert dB to Amplitude</h2>
    <script>
    function inlineDBConvert() {
      var d = document.getElementById("dbVal").value;
      document.getElementById("ampVal").value = Math.pow(10, (d/20)).toFixed(5);
    }
    </script>
    dB <input type="text" id="dbVal"> <input type="button" value="->" onClick="inlineDBConvert();return false;"> <input type="text" id="ampVal">
    <p>&nbsp;</p>
  </div>


  <div  class="tabContent" id="tabContent4">
    <!-- clarinet partials from http://www.phy.mtu.edu/~suits/clarinet.html -->
    <h2>Data Format</h2>

    <p style="width:600px;">
    Input data is written as JSON objects. In plain English, data input is structured
    so that a Web page parsing script can read it easily.<br>
    The parsing script expects to 'see' an array of objects, where each object
    contains the data representing a note. <br>

    <h2>Sample Config Fields</h2>
    <p style="width:600px;">
    <b>Sample Rate</b> is the output sample rate. 8000Hz is typical for Arduino audio applications.<br>
    <b>Amplitude scaling</b> is a multiplaction factor that is applied to the calculated sample value.
    The Sine function calculates values between 1 and -1, so some multiplaction factor is needed to
    generate samples suitable for PWM usage. <br>
    <b>DC Offset</b> is a constant value that is added to each sample. <br>
    <b>Normalize</b> when checked, dB values for partial data will be noralized to 0.
    <b>by %</b> controls the amount of normalization applied. For example, if dB values should be normalized
    by 10dB, and by % is 50, values will be increased by 50% of 10dB, ie. by 5dB.
    </p>

    <h2>Data Fields</h2>
    <p style="width:600px;">
    <b>The fields 'id' and 'frequency' are required.</b> Both fields should be unique for any given data set.<br>
    If <b>amplitude</b> is <i>not</i> included, a default value of 1.0 is used. <br>
    If <b>partials</b> are <i>not</i> included, a pure sign wave will be generated using the default value of [[1.0,1.0]].<br>
    If <b>partials</b> is the ID of another note, that note's partials will be used. <br>
    </p>

    <p>
    Partials data is an array of 2 element arrays, where element 1 is a partial interval,
    and element 2 is a dB level or amplitude value. For example, take this array with 3 data pairs:
    <pre><code>
    [
      [1, 0.80],
      [2, 0.6],
      [4, 0.4]
    ]
    </code></pre>
    'Translating' this into words would be some thing like:
    <pre><code>
    Generate a sample using proportions
    of these 3 harmonic elements:
      The note frequency at 80% amplitude,
      the 2nd harmonic at 60% amplitude,
      and the 4th harmonic at 40% amplitude.
    </code></pre>

    </p>

    <h2>Example</h2>
    <p style="width:600px;">
    Here's an example for generating clarinet samples at an 8000Hz sample rate.
    In the example, the note at 235Hz is defined with 7 harmonic partials, and no amplitude adjustment. Samples for
    the second note, at 470Hz, use the same partials as the first note, but adjust the amplitudes to
    make the sample data 'quieter.'
    <pre><code>
    [
	  { "id"        : "clarinet_fundemental",
	    "frequency" : 235.0,
	    "amplitude" : 1.0,
	    "partials"  : [
	                     [1.0, 1.0],
	                     [3.0, 0.75],
	                     [5.0, 0.5],
	                     [7.0, 0.14],
	                     [9.0, 0.5],
	                     [11.0, 0.12],
	                     [13.0, 0.17]
	                  ]
	  },

	  { "id"        : "clarinet_note_2",
	    "frequency" : 470.0,
	    "amplitude" : 0.92,
	    "partials"  : "clarinet_fundemental"
	  }
	]
    </code></pre>
    Partial data was taken from <a href="http://www.phy.mtu.edu/~suits/clarinet.html">here</a>.

  </div>


</body>
</html>

<!--
	int sampleRate = 0;
	int freq = 0;
	int amplitude = 0;
	int dcOffset = 0;
	String another = "";

	// Sinewave creation algorythm comes from:
	// http://embeddedsystemdesign.blogspot.com/2007/12/digital-dual-tone-generation-using.html
	//
	public void generateInstrument() {

        double increment = 0;
        int nSamples = 0;
		int i, n, s = 0;

		nSamples = sampleRate/freq;
		increment = 2.0 * Math.PI * ((float)freq/(float)sampleRate);

		System.out.print("f"+freq+"_sr"+sampleRate+"_len = "+nSamples+";");
		System.out.print("f"+freq+"_sr"+sampleRate+" ["+nSamples+"] = { ");

        for(i = 0; i < nSamples; i++) {

            s = dcOffset + (int)(amplitude * (

			Math.sin(increment*i)
			+ Math.sin(3*increment*i) *0.75
			+ Math.sin(5*increment*i) *0.5
			+ Math.sin(7*increment*i) *0.14
			+ Math.sin(9*increment*i) * 0.5
			+ Math.sin(11*increment*i) * 0.12
			+ Math.sin(13*increment*i) * 0.17
            )
            );

			System.out.print(s);

			if (i == nSamples -1) {
				System.out.println(" };");
			} else if (i % 20 == 0) {
				System.out.println(",");
			} else {
				System.out.print(", ");
			}

		}

	}





	// Sinewave creation algorythm comes from:
	// http://embeddedsystemdesign.blogspot.com/2007/12/digital-dual-tone-generation-using.html
	//
	public void generateSine() {

		double wT, y0, y1, y2 = 0;
		int nSamples = 0;
		int y = 0;

		nSamples = sampleRate/freq;
		wT = 2.0 * Math.PI * ((float)freq/(float)sampleRate);

		y0 = 0; /*initial value*/
		y1 = Math.sin (wT); /*initial value: sin (wT)*/

		System.out.print("f"+freq+"_sr"+sampleRate+"_len = "+nSamples+";");
		System.out.print("f"+freq+"_sr"+sampleRate+" ["+nSamples+"] = { ");

		for (int i=0; i<nSamples; i++) {

			y2 = (2*y1*Math.cos (wT)-y0); /*compute y2*/
			y = (int)(y2*amplitude)+50; /*amplitude scaling and dc shift*/
			y0 = y1; /*assign present values to previous value*/
			y1 = y2;
			System.out.print(y);
			if (i == nSamples -1) {
				System.out.println(" };");
			} else if (i % 20 == 0) {
				System.out.println(",");
			} else {
				System.out.print(", ");
			}

		}

	}

-->



<!--

function V1_parseInputData() {

  var increment = 0.0;
  var nSamples = 0;
  var n, i, j, p, a = 0;
  var s = [];


  var outputTxtArea = document.getElementById("results");
  outputTxtArea.value = "";
  var dataTxt = document.getElementById("editor").value;
  var dataObj = JSON.parse(dataTxt);

  var id = "";
  var freq = 0.0;
  var amplitude = 0.0;
  var partials;
  var sampleRate = document.getElementById("sampleRate").value;
  sampleRate = parseInt(sampleRate);
  var ampScalingFactor = document.getElementById("ampScalingFactor").value;
  ampScalingFactor = parseInt(ampScalingFactor);
  var dcOffset = document.getElementById("dcOffset").value;
  dcOffset = parseInt(dcOffset);
  var normVal = document.getElementById("normVal").value;
  if (isNaN(normVal)) normVal = 100;
  else normVal = parseInt(normVal);

  var normalize = document.getElementById("normalize").checked;


  if (DEBUG) alert (JSON.stringify(dataObj));
  if (DEBUG) alert ("sample rate: " + sampleRate +"\namp scaling: " + ampScalingFactor +"\ndc offset: " +dcOffset);


  // Sinewave generation derived from pseudocode at
  //     http://www.topherlee.com/software/pcm-tut-sine.html
  //
  for (n=0; n < dataObj.length; n++) {

    s = [];

    id = dataObj[n]["id"];
    freq = dataObj[n]["frequency"]; // frequency of note
    if (dataObj[n]["amplitude"])
      amplitude = dataObj[n]["amplitude"]; // amplitude adjust for note (higher notes typically quieter)
    else
      amplitude = 1.0;
    if (dataObj[n]["partials"])
      partials = dataObj[n]["partials"]; // list of partials and amplitudes for note
    else
      partials = [ [1.0, 1.0] ];

    convertDecibelsToAmplitude(partials, normalize, normVal);

    nSamples = parseInt(sampleRate/freq);
	increment = 2 * Math.PI * (freq/sampleRate);

    if (typeof partials == "string") {
      if (DEBUG) alert ("Copying partials for \'" + dataObj[n]["id"] + "\' from \'" + partials +"\'");
      partials = getPartialsById(partials);
    }

    for(i = 0; i < nSamples; i++) {

      // accumulate sample values with calculated partials
      // make positive 2.0 >= s <= 0.0
      // multiply by amplitude factor (default = 127)

      s[i] = 0.0;

      for (j = 0; j < partials.length; j++) {

        p = partials[j][0];
        a = partials[j][1];

        s[i] += Math.sin(p*increment*i) * a;


      }
      // adjust sample for amplitude scaling and dc offset
      s[i] = dcOffset + (ampScalingFactor * s[i])


      // scale by frequency sample specific ampl;itude correction
      // AND make a whole number for uC PWM output

      s[i] = parseInt(amplitude * s[i]);

	}

    if (DEBUG) alert (s);

	outputTxtArea.value +=    "f"+id+"_sr"+sampleRate+"_len = "+nSamples+";"
	                        + "\n"
	                        + "f"+id+"_sr"+sampleRate+" ["+nSamples+"] = { "
	                        + s
	                        + "\n"
	                        + "};"
	                        + "\n\n";

  } // end for (var in object)


  openTab(2);

}

-->